<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reconhecimento de D√≠gitos - MLP Grid 28x28</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-4xl">
    <h1 class="text-3xl font-bold text-gray-800 text-center">üßÆ Reconhecimento de D√≠gitos</h1>
    <p class="text-gray-500 text-center mb-6">Desenhe um n√∫mero de 0 a 9 no grid abaixo</p>

    <!-- instru√ß√µes -->
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
      <h2 class="font-semibold text-gray-700">Como usar:</h2>
      <ul class="list-disc list-inside text-gray-600 text-sm">
        <li>Clique ou arraste no grid para desenhar</li>
        <li>Ajuste o tamanho do pincel</li>
        <li>Marque/desmarque "Desenhar" para apagar</li>
        <li>Clique em <span class="font-semibold">Classificar</span> para ver a previs√£o</li>
      </ul>
    </div>

    <!-- controles de pincel -->
    <div class="flex flex-wrap items-center justify-center gap-6 mb-6">
      <div class="flex items-center gap-3">
        <label class="font-medium">Tamanho do Pincel:</label>
        <input type="range" id="brushSize" min="1" max="5" value="1" class="w-32">
        <span id="brushSizeValue" class="font-mono">1</span>
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="drawMode" checked class="w-5 h-5 text-blue-600 rounded">
        <label for="drawMode" class="font-medium">Desenhar (desmarque = apagar)</label>
      </div>
    </div>

    <!-- grid -->
    <div class="flex justify-center mb-6">
      <div id="grid" class="grid grid-cols-28 grid-rows-28 border-4 border-gray-800"
           style="width: 560px; height: 560px;"></div>
    </div>

    <!-- bot√µes -->
    <div class="flex flex-wrap justify-center gap-4 mb-6">
      <button id="predictBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">Classificar</button>
      <button id="clearBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg shadow hover:bg-red-700 transition">Limpar</button>
      <button id="toggleMatrixBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition">Mostrar Matriz</button>
    </div>

    <!-- loading -->
    <div id="loading" class="hidden flex justify-center mb-4">
      <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-600"></div>
    </div>

    <!-- resultado -->
    <div id="result" class="hidden p-4 rounded-lg border-l-4"></div>

    <!-- matriz -->
    <pre id="matrixDisplay" class="hidden bg-gray-50 border rounded-lg p-3 text-xs font-mono overflow-y-auto max-h-40 mt-4"></pre>
  </div>

  <script>
    let grid = [];
    let isMouseDown = false;
    let brushSize = 1;
    let drawMode = true;

    const gridElement = document.getElementById('grid');
    const predictBtn = document.getElementById('predictBtn');
    const clearBtn = document.getElementById('clearBtn');
    const toggleMatrixBtn = document.getElementById('toggleMatrixBtn');
    const result = document.getElementById('result');
    const loading = document.getElementById('loading');
    const brushSizeSlider = document.getElementById('brushSize');
    const brushSizeValue = document.getElementById('brushSizeValue');
    const drawModeCheckbox = document.getElementById('drawMode');
    const matrixDisplay = document.getElementById('matrixDisplay');

    function initGrid() {
      grid = Array(28).fill().map(() => Array(28).fill(0));
      gridElement.innerHTML = '';
      for (let r = 0; r < 28; r++) {
        for (let c = 0; c < 28; c++) {
          const pixel = document.createElement('div');
          pixel.className = 'w-[20px] h-[20px] border border-gray-200';
          pixel.dataset.row = r;
          pixel.dataset.col = c;
          pixel.addEventListener('mousedown', handlePixelClick);
          pixel.addEventListener('mouseenter', handlePixelEnter);
          pixel.addEventListener('touchstart', handleTouchStart, { passive: false });
          pixel.addEventListener('touchmove', handleTouchMove, { passive: false });
          gridElement.appendChild(pixel);
        }
      }
    }

    brushSizeSlider.addEventListener('input', e => {
      brushSize = parseInt(e.target.value);
      brushSizeValue.textContent = brushSize;
    });
    drawModeCheckbox.addEventListener('change', e => {
      drawMode = e.target.checked;
    });

    function handlePixelClick(e) {
      e.preventDefault(); isMouseDown = true;
      paintPixels(+e.target.dataset.row, +e.target.dataset.col);
    }
    function handlePixelEnter(e) {
      if (isMouseDown) paintPixels(+e.target.dataset.row, +e.target.dataset.col);
    }
    function handleTouchStart(e) {
      e.preventDefault(); isMouseDown = true;
      paintPixels(+e.target.dataset.row, +e.target.dataset.col);
    }
    function handleTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      if (el?.dataset?.row) paintPixels(+el.dataset.row, +el.dataset.col);
    }
    document.addEventListener('mouseup', () => isMouseDown = false);
    document.addEventListener('touchend', () => isMouseDown = false);

    function paintPixels(r, c) {
      const radius = Math.floor(brushSize / 2);
      for (let i = r - radius; i <= r + radius; i++) {
        for (let j = c - radius; j <= c + radius; j++) {
          if (i >= 0 && i < 28 && j >= 0 && j < 28) {
            const d = Math.sqrt((i - r) ** 2 + (j - c) ** 2);
            if (d <= radius) {
              grid[i][j] = drawMode ? 255 : 0;
              updatePixel(i, j);
            }
          }
        }
      }
    }
    function updatePixel(r, c) {
      const pixel = gridElement.children[r * 28 + c];
      pixel.style.backgroundColor = grid[r][c] ? '#000' : '#fff';
    }

    clearBtn.addEventListener('click', () => {
      initGrid();
      result.classList.add('hidden');
      matrixDisplay.classList.add('hidden');
    });

    toggleMatrixBtn.addEventListener('click', () => {
      if (matrixDisplay.classList.contains('hidden')) {
        matrixDisplay.textContent = grid.map(row => row.map(x => x.toString().padStart(3, ' ')).join(' ')).join('\n');
        matrixDisplay.classList.remove('hidden');
        toggleMatrixBtn.textContent = 'Esconder Matriz';
      } else {
        matrixDisplay.classList.add('hidden');
        toggleMatrixBtn.textContent = 'Mostrar Matriz';
      }
    });

    predictBtn.addEventListener('click', async () => {
      loading.classList.remove('hidden');
      predictBtn.disabled = true;
      result.classList.add('hidden');
      try {
        const response = await fetch('/predict', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ grid })
        });
        const data = await response.json();
        if (data.success) {
          result.innerHTML = `<p class="text-2xl font-bold text-blue-600">D√≠gito: ${data.numero}</p>
                              <p class="text-gray-600">Certeza: ${data.certeza.toFixed(2)}%</p>`;
          result.className = 'mt-4 p-4 rounded-lg border-l-4 border-blue-600 bg-blue-50';
        } else {
          result.textContent = `Erro: ${data.error}`;
          result.className = 'mt-4 p-4 rounded-lg border-l-4 border-red-600 bg-red-50';
        }
      } catch {
        result.textContent = 'Erro: falha na comunica√ß√£o com o servidor';
        result.className = 'mt-4 p-4 rounded-lg border-l-4 border-red-600 bg-red-50';
      }
      result.classList.remove('hidden');
      loading.classList.add('hidden');
      predictBtn.disabled = false;
    });

    initGrid();
  </script>
</body>
</html>
